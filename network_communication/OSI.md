OSI: Open System Interconnection model

# OSI 7层模型：概念与典型代表（工程化速查）

| 层级 | 概念/职责 | 典型代表 | 一句话说明 |
| --- | --- | --- | --- |
| 应用层 (L7) | 面向具体应用的协议与语义（请求/响应、资源/方法、业务数据） | HTTP、FTP、SMTP、DNS、gRPC（框架） |
| 表示层 (L6) | 数据表示/编解码、压缩、加密等“表现形式”转换（常被应用层库吸收） | JSON、Protobuf、JPEG、gzip；TLS/SSL（常被视为跨层安全机制） |
| 会话层 (L5) | 会话/对话管理（建立/保持/恢复/检查点），现实协议栈中常弱化并入应用层 | SMB session 等； |
| 传输层 (L4) | 端到端传输与复用（端口）、可靠性/拥塞控制（TCP）或尽力而为（UDP） | TCP、UDP、QUIC（基于UDP的传输/应用融合协议） | 端到端传输 |
| 网络层 (L3) | 跨网段寻址与路由转发（IP）、分片与生存时间（TTL） | IPv4/IPv6、ICMP、IPsec；路由器 | 跨同网段 |
| 数据链路层 (L2) | 成帧、MAC寻址、介质访问控制、差错检测（CRC）、二层交换 | Ethernet(802.3)、Wi‑Fi(802.11)、VLAN(802.1Q)、MAC；交换机 | 通过Mac寻址 |
| 物理层 (L1) | 比特传输的电/光/射频信号与编码、速率、接口规范 | 双绞线/光纤/射频、PHY收发器、1000BASE‑T 等 |

> 备注：ARP 常被称为 “2.5层” 协议（在二层广播域内为三层 IP 解析 MAC），放在 L2 速查中更符合工程使用习惯。

## 常用速查

### 各层 PDU（数据单元）

- **L1**：bit（比特）
- **L2**：frame（帧）
- **L3**：packet（包/分组）
- **L4**：segment（TCP 段）/ datagram（UDP 数据报）

### 各层“地址/标识”

- **L2**：MAC 地址（同一二层广播域内有效）
- **L3**：IP 地址（跨网段路由）
- **L4**：端口（进程/服务的复用与分用）

### 典型设备归属（用于快速定位问题所在层）

- **L1**：中继/光电转换/PHY（更偏“信号转发与介质”）
- **L2**：交换机/网桥（看 MAC 表转发）
- **L3**：路由器/三层交换（基于 IP 路由转发）

### L1 常见 PHY 标准与排查要点（工程高频）

**常见 PHY/物理规范（按场景）**

- **以太网 PHY（IEEE 802.3 物理层族）**：10BASE‑T、100BASE‑TX、1000BASE‑T、10GBASE‑SR/LR 等
- **Wi‑Fi PHY（IEEE 802.11 物理层族）**：802.11n/ac/ax（调制/带宽/MIMO 等随标准演进）
- **串行/工业现场常见物理接口**：RS‑232、RS‑485（差分）、CAN 物理层（终端电阻、总线拓扑对稳定性影响很大）
- **光纤/光模块相关**：单模/多模、SFP/SFP+/QSFP 模块形态（对应不同速率/波长/距离的物理规范）

**排查要点（从“信号/介质”入手）**

- **链路是否真的 up**：接口 `LOWER_UP`、是否频繁 link flap
  - 命令：`ip link`
- **速率/双工/自协商是否匹配**：Speed/Duplex/Auto‑negotiation；两端不一致会导致大量误码/重传
  - 命令：`ethtool <iface>`
- **线缆/连接器/屏蔽与接地**：水晶头压接、线序、线缆等级（Cat5e/6）、现场强干扰（电机/变频器）导致的瞬时误码
- **误码计数（典型是 CRC/frame/symbol error）**：CRC 持续增长通常优先怀疑物理介质或双工/协商问题
  - 命令：`ethtool -S <iface>`（看 rx_crc_errors 等计数）
- **驱动/硬件协商日志**：必要时结合内核日志定位 PHY 反复协商或掉线原因
  - 命令：`dmesg --follow`

### L2 常见协议/机制与排查要点（工程高频）

**常见协议/机制（按“二层网络怎么跑”来记）**

- **Ethernet / MAC（IEEE 802.3）**：二层帧、MAC 寻址、FCS/CRC 差错检测（交换机按 MAC 表转发）
- **VLAN（IEEE 802.1Q）**：二层打标签划分广播域；涉及 Access/Trunk、VLAN 允许列表
- **STP/RSTP/MSTP（802.1D / 802.1w / 802.1s）**：二层防环；避免广播风暴、MAC 表震荡
- **链路聚合 LACP（802.1AX/802.3ad）**：多链路绑定一条逻辑链路（带宽+冗余）；负载分担通常基于哈希
- **LLDP（802.1AB）**：二层邻居发现（“我是谁/接到哪个口”），布线与拓扑排障很有用

> 备注：**ARP（IPv4）** 常被称为 **2.5 层**（在二层广播域内为三层 IP 解析 MAC）；IPv6 对应机制是 NDP（基于 ICMPv6，多播依赖 L2）。

**排查要点（从“广播域/转发/多播”入手）**

- **是否在同一二层广播域**：VLAN 是否一致、Trunk 是否放行对应 VLAN、是否存在无线隔离/端口隔离
- **MAC 学习是否正常**：是否出现 MAC 表震荡/漂移（常见于环路或链路聚合配置错误）
- **广播/多播是否被限制**：IGMP snooping、交换机安全策略、Wi‑Fi 省电/组播转单播等会影响发现类协议（ROS2/DDS 常踩）
- **从报文侧确认**：抓二层帧/ARP/多播是否出现、是否到达预期端口
  - 命令：`tcpdump -i <iface> -e`（显示二层头，观察 MAC/VLAN/ARP）

**Linux 常用命令**

- **查看 VLAN/二层设备**：`ip -d link`（含 VLAN 等详细信息）
- **查看/管理网桥与 FDB**：`bridge link`、`bridge vlan`、`bridge fdb`
- **查看邻居表（ARP/ND）**：`ip neigh`

### L3 常见协议/机制与排查要点（工程高频）

**常见协议/机制（按“跨网段怎么走”来记）**

- **IPv4/IPv6（IP）**：三层寻址与转发（源/目的 IP、路由选择、TTL/hop limit）；IPv4 还涉及分片（工程上更常用 PMTU 避免分片）
- **ICMP / ICMPv6**：网络控制与诊断（`ping`、不可达、超时、PMTU 相关报文）；`traceroute` 也依赖其返回
- **NDP（IPv6 Neighbor Discovery，基于 ICMPv6）**：地址解析、DAD（重复地址检测）、RA/RS（路由器通告/请求）等
- **IPsec（AH/ESP）**：三层加密/认证（常用于 VPN/隧道场景）

> 备注：**ARP（IPv4）** 常被称为 **2.5 层**（在二层广播域内为三层 IP 解析 MAC），但它与“本机如何把 IP 包发到下一跳”强相关，工程排障通常会与 L3 一起看。

**排查要点（从“地址/路由/MTU/策略”入手）**

- **地址/掩码是否正确**：同网段判断、是否出现重复地址
  - 命令：`ip addr`
- **路由表/默认网关是否正确**：去某个网段走哪张表/哪条路由
  - 命令：`ip route`（必要时 `ip route get <dst>` 看实际选路）
- **策略路由/多网卡影响**：不同源地址走不同路由（多网卡/容器/VPN 场景常见）
  - 命令：`ip rule`
- **路径与可达性**：是否能到、在哪一跳断
  - 命令：`ping`、`traceroute`（或 `tracepath` 更偏 MTU/路径探测）
- **MTU/PMTU 问题**：典型现象是“小包通、大包卡”
  - 命令：`ip link`（看 MTU）、`tracepath <dst>`、`ping -M do -s <size> <dst>`（IPv4 常用）
- **从报文侧确认**：确认 ICMP 不可达/超时/分片相关报文是否被过滤
  - 命令：`tcpdump -i <iface> icmp or icmp6`

### L4 常见协议/机制与排查要点（工程高频）

**常见协议/机制（按“端到端怎么传”来记）**

- **TCP**：面向连接、可靠按序（序号/ACK/重传）、流控（rwnd）、拥塞控制（cwnd）；适合“不能丢”的数据传输
- **UDP**：无连接、尽力而为（可能丢/乱序/重复）；适合低时延、可容忍丢包或由应用层补偿的场景（ROS2/DDS 常见）
- **端口（Port）**：L4 复用/分用的关键（同一 IP 上承载多个服务）；常见现象是“端口没开/被防火墙挡住导致通信失败”
- **MSS（TCP）与 MTU 的关系**：\( MSS \approx MTU - IP\_hdr - TCP\_hdr \)。MTU/PMTU 异常常表现为“小包通、大包卡”
- **QUIC**：基于 UDP 的传输/安全/部分应用特性融合协议（工程上常与 TCP 对比；严格分层上不完全等同传统 L4）

**排查要点（从“端口/重传/分片/丢包”入手）**

- **服务是否在监听、监听在哪个地址/端口**（0.0.0.0/:: 还是仅本地回环）
  - 命令：`ss -tulpn`
- **是否存在大量重传/拥塞**（TCP 性能差常见根因）
  - 命令：`ss -ti`（看 retrans/cwnd/rto 等）
- **UDP 大包/分片问题**：UDP 丢一个分片就等于整包丢；尤其在隧道/VPN/跨网段时更敏感
  - 命令：`ip link`（看 MTU）、`tracepath <dst>`、`tcpdump -i <iface> udp`
- **防火墙/安全策略**：端口是否放行、是否对入站/转发有限制
  - 命令：`nft list ruleset`（或 `ufw status`）
- **从报文侧确认握手/端口可达**：是否收到 SYN/SYN-ACK、是否有 ICMP port unreachable 等
  - 命令：`tcpdump -i <iface> tcp or udp`

### L5 常见机制与排查要点（工程高频）

> 说明：在现代 TCP/IP 体系中，**会话层（L5）往往不以“独立协议层”出现**，其能力常被 **应用层/中间件**实现（会话 ID、心跳、重连、恢复等）。所以这里按“会话语义/机制”来总结更贴近工程。

**常见机制/语义（按“对话状态怎么维持”来记）**

- **会话标识与上下文**：session id / token / connection id；用于把多次交互关联到同一“对话”
- **保活与存活性（Keepalive / Heartbeat / Liveliness）**：周期性心跳 + 超时判定，避免“假在线”
- **会话恢复/重连策略**：断线重连、指数退避、重放/去重、重订阅、状态重建（检查点/断点续传思想）
- **对话控制**：请求-响应关联（request id）、并发会话管理、半双工/全双工控制（更多由上层协议定义）
- **典型“带会话语义”的协议/体系**：SMB 的 session 语义等（用于理解 L5 的职责边界）

**排查要点（从“超时/心跳/状态恢复”入手）**

- **频繁掉线/重连风暴**：优先检查心跳间隔、超时阈值、网络抖动/丢包下是否过于激进
- **“看见过但很快消失”**：关注租约/会话超时（例如中间件的 liveliness/lease duration 类参数）
- **状态不一致**：断线后是否正确重建订阅/会话上下文，是否存在重复请求/幂等性问题
- **从证据侧定位**：抓包确认心跳是否发出/是否到达；结合应用/中间件日志看超时与重连原因
  - 命令：`tcpdump -i <iface> -n`（配合过滤条件观察心跳/保活流量）、应用/中间件日志（最关键）

### L6 常见机制与排查要点（工程高频）

> 说明：表示层（L6）关注“**数据如何表示**”：编解码/序列化、压缩、加密等。在现实工程里它常被并入应用层或中间件库中实现。

**常见机制（按“数据怎么变成字节流”来记）**

- **序列化/数据格式**：
  - **文本类**：JSON、XML、YAML（可读性好但体积更大）
  - **二进制类**：Protobuf、FlatBuffers、MessagePack、CBOR（更紧凑、更高效，实时/带宽敏感场景常用）
  - **对比要点**：
    - **可读性/调试**：文本类可直接读/手改/更利于 diff；二进制类通常需要工具解码
    - **自描述 vs schema**：文本类字段名在数据里更“自描述”；Protobuf/FlatBuffers 等更依赖 schema/IDL 做一致解析
    - **体积/性能**：二进制类通常更省带宽、解析更快；文本类开销更大但更灵活
    - **适用场景**：配置/调试/低频接口偏文本；高频/大消息/实时链路偏二进制
- **字符编码/字节序**：UTF‑8、大小端（Endianness）、字段对齐/浮点表示等
- **压缩**：gzip/deflate、zstd、lz4（压缩率 vs CPU/时延的权衡）
- **加密/认证/完整性**：TLS/SSL（教材常放 L6；工程上更常视为跨层安全机制/应用侧安全层）

#### Unicode 字符与字符编码（UTF‑8/UTF‑16/UTF‑32）

**Unicode 是什么**

- **Unicode** 是一套“给字符分配编号”的标准。每个字符对应一个 **码点（code point）**，写作 `U+XXXX`（十六进制）。
- 抽象意义上的文本可以理解为一段 **Unicode 字符（码点）序列**：先有“字符/码点”，再选择一种编码把它变成字节。

**字符编码是什么**

- **字符编码（encoding）**定义“码点如何变成 bytes（字节）”：
  - **UTF‑8**：可变长 1–4 字节；ASCII 兼容；网络协议/接口中最常见
  - **UTF‑16**：可变长 2 或 4 字节（代理对）；某些系统/语言内部表示常见
  - **UTF‑32**：固定 4 字节；简单但更占空间

**工程高频坑**

- **乱码**：发送端用 UTF‑8 编码，接收端按 GBK/本地默认编码解码（或反过来）。
  - 解决：接口/文件/日志 **统一约定 UTF‑8**。
  - 例子：JSON 语义上是 Unicode 字符序列，但落到“字节”层仍需要双方约定同一种编码（工程上几乎都用 UTF‑8）。
- **“字符数”不等于“字节数”**：UTF‑8 下一个中文通常占 3 字节，emoji 可能 4 字节；按字节截断会破坏字符边界。
- **“一个可见字符”不一定是一个码点**：组合字符（字母+重音）、某些 emoji（多个码点组合）会影响长度统计与截断策略（需要按 grapheme cluster 处理时要更谨慎）。
- **规范化（Normalization）**：同一个“看起来一样”的字符序列可能有不同码点组合（NFC/NFD）。在做比较、哈希、索引时要明确是否需要规范化。

**排查要点（从“兼容性/开销/失败模式”入手）**

- **字段/类型不一致**：同名字段不同类型、schema 版本不一致会导致解析失败或数据错位
  - 抓手：对齐双方消息定义/IDL，检查版本兼容策略（向前/向后兼容）
- **乱码/文本解析异常**：常见是编码不一致（UTF‑8 vs GBK）或非预期二进制被当文本处理
  - 抓手：明确全链路 UTF‑8；抓包/日志中区分“字节流”与“字符串”
- **CPU 飙升/延迟增大**：压缩、序列化/反序列化开销过大（尤其大消息：图像/点云）
  - 抓手：对比开关压缩前后 CPU/带宽；选择更快算法（lz4）或降低压缩等级
- **TLS 相关失败**：握手失败、证书不信任、时间不准（证书有效期）、SNI/域名不匹配
  - 抓手：先确认时间/NTP；再看证书链与主机名；抓包/日志定位握手阶段

### L7 常见协议/机制与排查要点（工程高频）

**常见协议/框架（按“应用怎么说话”来记）**

- **HTTP/HTTPS**：最常见的 API/资源访问协议（REST、文件上传下载等）
- **WebSocket**：基于 TCP 的全双工长连接（实时推送/交互）
- **DNS**：域名解析（虽是基础设施，但协议语义属于应用层）
- **MQTT**：轻量发布订阅（IoT/机器人边缘设备常见）
- **gRPC**：RPC 框架（IDL + 代码生成，常基于 HTTP/2；序列化常用 Protobuf）
- **ROS2 视角**：话题/服务/动作属于应用语义；底层通过 DDS/RTPS 提供发现与数据分发（更像“中间件/应用层能力”）

**排查要点（从“语义/兼容性/安全/观测性”入手）**
&
- **语义不一致**：字段含义、单位、坐标系、时间戳基准不一致（机器人系统高频问题）
  - 抓手：接口文档/消息定义写清楚单位与坐标系；必要时加版本号与校验
- **接口/消息兼容性**：新增字段、删除字段、类型变更导致的兼容问题
  - 抓手：采用向前/向后兼容策略（可选字段、保留字段号/字段名、版本化接口）
- **超时/重试导致雪崩**：上游重试放大下游压力，出现级联故障
  - 抓手：合理超时、指数退避、熔断/限流；区分“可重试/不可重试”错误
- **鉴权/授权与安全**：token/证书、权限边界、输入校验、防重放
  - 抓手：先排证书/时间/信任链，再看权限与接口参数；保留足够的审计日志
- **可观测性不足**：跨进程/跨机器问题难定位
  - 抓手：统一 trace id/request id；关键路径埋点（延迟、错误率、重试次数）

## OSI 与 TCP/IP（现实栈）的大致映射

- **TCP/IP 应用层** ≈ OSI 的 **L7 + L6 + L5**
- **TCP/IP 传输层** ≈ OSI 的 **L4**
- **TCP/IP 网际层** ≈ OSI 的 **L3**
- **TCP/IP 网络接口层** ≈ OSI 的 **L2 + L1**

## 机器人/ROS2 场景的跨层提醒（高频）

- **常见链路**：ROS2 → DDS/RTPS → UDP（常见）/TCP（可选）→ IP → Ethernet/Wi‑Fi
- **“能 ping 通但 ROS2 发现/通信异常”**常见原因不在 L3：
  - **L2/多播相关**：DDS 发现常依赖多播；Wi‑Fi、交换机 IGMP snooping、VLAN、隔离策略可能影响多播/广播
  - **L4/防火墙**：UDP 端口范围、入站策略、NAT/容器网络导致的可达性问题
  - **应用层 QoS**：可靠性、历史深度、durability 等不匹配会出现“看见但收不到/间歇性丢”

## 排障工具按层速查（Linux）

- **L2**：`ip link`、`ethtool`、`bridge fdb`、`arp -n`/`ip neigh`
- **L3**：`ip addr`、`ip route`、`ping`、`traceroute`
- **L4**：`ss -tulpn`、`nft list ruleset`/`ufw status`
- **抓包（跨层）**：`tcpdump`（配合网卡/接口与过滤表达式）